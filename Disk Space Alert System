import psutil
import smtplib
from email.message import EmailMessage

# --- STEP 1: Monitoring Logic ---
def check_disk_usage():
    # Get disk usage of the main drive ('/')
    disk = psutil.disk_usage('/')
    usage_percent = disk.percent
    
    print(f"Current Disk Usage: {usage_percent}%")

    # Set your threshold (Limit)
    LIMIT = 80 

    if usage_percent > LIMIT:
        print(" ALERT: Disk space is low! Sending Email...")
        send_alert_email(usage_percent)
    else:
        print("Status: Disk space is healthy.")

# --- STEP 2: Email Logic ---
def send_alert_email(percent):
    # Create the email content
    msg = EmailMessage()
    msg.set_content(f"Warning: Your server disk usage is at {percent}%. Please clean up files!")
    msg['Subject'] = " CRITICAL: Low Disk Space Alert"
    msg['From'] = "your_email@gmail.com"
    msg['To'] = "admin_email@gmail.com"

    # Connect to Gmail's Server (SMTP)
    try:
        with smtplib.SMTP_SSL('smtp.gmail.com', 465) as server:
            # Use an 'App Password', not your regular Gmail password
            server.login("your_email@gmail.com", "your_app_password")
            server.send_message(msg)
        print(" Email sent successfully!")
    except Exception as e:
        print(f" Failed to send email: {e}")

if __name__ == "__main__":
    check_disk_usage()